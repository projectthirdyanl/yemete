version: '3.8'

# Docker Compose for Web Platform (192.168.120.50)
# This runs the Next.js application

services:
  web:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: yametee-web
    ports:
      - '3000:3000'
    environment:
      # Database connection to external PostgreSQL (192.168.120.42)
      - DATABASE_URL=${DATABASE_URL}
      # Redis connection to external Redis (192.168.120.44)
      - REDIS_URL=${REDIS_URL:-redis://192.168.120.44:6379}
      # Payment processing
      - PAYMONGO_SECRET_KEY=${PAYMONGO_SECRET_KEY}
      - PAYMONGO_PUBLIC_KEY=${PAYMONGO_PUBLIC_KEY}
      - PAYMONGO_WEBHOOK_SECRET=${PAYMONGO_WEBHOOK_SECRET}
      # Authentication
      - NEXTAUTH_URL=${NEXTAUTH_URL:-http://192.168.120.50:3000}
      - NEXTAUTH_SECRET=${NEXTAUTH_SECRET}
      - ADMIN_JWT_SECRET=${ADMIN_JWT_SECRET}
      # Application
      - NODE_ENV=production
      - PORT=3000
      - HOSTNAME=0.0.0.0
    volumes:
      - ./prisma:/app/prisma:ro
    restart: unless-stopped
    networks:
      - yametee-network
    healthcheck:
      test: ['CMD', 'curl', '-f', 'http://localhost:3000/api/health']
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

networks:
  yametee-network:
    driver: bridge
    # Note: In Proxmox, ensure VMs can communicate via bridge networking
